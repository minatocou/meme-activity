!function(){function e(){var e=this,t=e.customUploadBtnId,a=(e.customUploadContainerId,$("#"+t).closest(".wangEditor-drop-panel")),n=WebUploader.create({auto:!0,server:"/imageuploader/full",pick:"#"+t,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/!*"}});n.option("compress",{width:750,height:16e3,quality:100,compress:null,allowMagnify:!0,crop:!1,chunked:!0,preserveHeaders:!0,noCompressIfLarger:!1});var i,l;n.on("beforeFileQueued",function(){$("#"+t).addClass("active"),a.find(".tab-container").append('<span class="uploadTip">正在上传</span>'),a.show()}),n.on("uploadSuccess",function(n,r){{var s=JSON.parse(r._raw);n.name.replace(".jpg","")}return 1!=s.code?void alert(s.msg[0]):void(s.data&&(l=s.data[750],e.command(null,"insertHtml",'<img src="'+l+'" style="max-width:100%;"/>'),$.ajax({url:"/api/picture/save",type:"post",dataType:"json",data:{imgsrc:l},success:function(e){a.find(".tab-container .uploadTip").remove(),a.find(".tab-container").append('<span class="uploadedTip">图片上传成功</span>'),setTimeout(function(){a.find(".tab-container .uploadedTip").remove(),a.hide()},1e3),$("#"+t).hasClass("active")&&$("#"+t).removeClass("active"),i=e.id}})))})}function t(e){var t=e?e:"";$.when($.ajax({url:"/api/internal/sas/tag/getComponentCategory",type:"post",dataType:"json",data:{scene:2,type:2,id:t},success:function(e){console.log(e.msg)},error:function(){console.error("出现异常")}})).done(function(e){if(1==e.code){for(var t=e.data,a=!1,n="",i="",l=0;l<t.length;l++)1==t[l].selected?(n+='<li class="current" data-val='+t[l].category_id+">"+t[l].name+"</li>",a=!0):n+="<li data-val="+t[l].category_id+">"+t[l].name+"</li>";a?$(".label-tags").html(n):($(n).each(function(e,t){0==e?($(t).addClass("current"),i+=t.outerHTML):i+=t.outerHTML}),$(".label-tags").html(i))}else console.log("出现异常")}).then(function(e){if(e.data.length){var t=e.data[0].category_id;a(t)}}),$.ajax({url:"/api/internal/sas/tag/getObjTag",type:"post",dataType:"json",data:{scene:2,type:2,id:t},success:function(e){if(1==e.code){var t=e.data,a="";if(t.length){for(var n=0;n<t.length;n++)a+="<li data-val="+t[n].tag_id+" data-txt="+t[n].label+">"+t[n].label+"</li>";$(".label-list ul").html(a)}}else console.log("出现异常")},error:function(){console.error("出现异常")}})}function a(e){var t=s?s:"";$.ajax({url:"/api/internal/sas/tag/getComponentTag",type:"post",dataType:"json",data:{category_id:e,scene:2,type:2,id:t},success:function(e){if(1==e.code){for(var t=e.data,a="",n=0;n<t.length;n++)a+=1==t[n].selected?1==t[n].is_visible?'<li class="current" data-val='+t[n].tag_id+">"+t[n].label+"</li>":'<li class="current" data-val='+t[n].tag_id+">"+t[n].label+'<i class="fa fa-low-vision"></i></li>':1==t[n].is_visible?"<li data-val="+t[n].tag_id+">"+t[n].label+"</li>":"<li data-val="+t[n].tag_id+">"+t[n].label+'<i class="fa fa-low-vision"></i></li>';$(".label-table").html(a)}else console.log("出现异常")},error:function(){console.error("出现异常")}})}function n(e){for(var t in e){if(void 0==e[t]||""==e[t])return $(".teletext-table").find(".t-"+t).addClass("err"),!1;$(".teletext-table").find(".t-"+t).removeClass("err")}return!0}function i(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(t);return null!=a?a[2]:null}function l(e,t){var a,n=$.trim(t).split(",");if("sku"==e){a="";for(var i=0;i<n.length;i++)a+='<span class="skus-item">'+n[i]+'<i class="del-prd"></i></span>'}return a}var r=new wangEditor("editor");r.config.printLog=!1,r.config.menus=["source","|","fontsize","bold","underline","italic","forecolor","bgcolor","|","eraser","alignleft","aligncenter","alignright","|","link","unlink","img","undo","|","intoDiv"],r.onchange=function(){console.log("change"),console.log($(".teletext-prd").length)},r.config.customUpload=!0,r.config.customUploadInit=e,r.create();var s=i("id");if(s){var o,c=$("body").data("preview"),d=c.split("activity/")[0];(d.indexOf("qaapp.cn.m")>0||d.indexOf("preprod.cn.m")>0)&&(d=d.replace(/qaapp.cn.m/i,"qaappm.cn"),d=d.replace(/preprod.cn.m/i,"preprodm.cn")),o=d+"m/special/teletext/index.html?id="+s,$(".teletext-head .preview-btn").attr("disabled",!1),$(".teletext-head .publish-btn").attr("disabled",!1),$(".preview-wrapper .qr").find(".p-link > p").html(o),$(".preview-wrapper .qr").find(".teletextId > span").html(s),$.ajax({url:"/api/internal/sas/ImageText/detail",type:"post",dataType:"json",data:{id:s},success:function(e){if(1==e.code){var t=$("#teletext-content"),a=e.data;for(var n in a)if("cover"==n)t.find(".teletext-imgBox").html('<img class="currenImg" src="'+a[n]+'" alt="">');else if("title"==n)t.find("input[name='title']").val(a[n]);else if("author"==n)t.find("input[name='author']").val(a[n]);else if("skus"==n){if(a[n]){var i=l("sku",a[n]);$("#tele-skus").html(i)}}else"content"==n?r.$txt.html(a.content):"status"==n&&(1==a.status?($(".publish-btn").attr("data-val",1),$(".publish-btn > span").html("下线")):($(".publish-btn").attr("data-val",0),$(".publish-btn > span").html("发布")))}},error:function(){console.log("出现异常")}})}else $(".teletext-head .preview-btn").attr("disabled",!0),$(".teletext-head .publish-btn").attr("disabled",!0);t(s),$(".teletext-head").on("click",".preview-btn",function(){var e,t=i("id"),a=($(".header-container").data("magento"),$("body").data("preview")),n=a.split("activity/")[0];(n.indexOf("qaapp.cn.m")>0||n.indexOf("preprod.cn.m")>0)&&(n=n.replace(/qaapp.cn.m/i,"qaappm.cn"),n=n.replace(/preprod.cn.m/i,"preprodm.cn")),t&&(e=n+"m/special/teletext/index.html?id="+t,$("#qrCode").qrcode({width:64,height:64,text:e}),$(".qr .link p").html(e),$(".preview-wrapper .preview").html('<iframe src="'+e+'?preview=1" frameborder="0"></iframe>'),$(".preview-wrapper").show())}),$(".teletext-head").on("click",".publish-btn",function(){var e,t=($(this),$(".publish-btn").attr("data-val")),a=$("body").data("preview"),n=a.split("activity/")[0];(n.indexOf("qaapp.cn.m")>0||n.indexOf("preprod.cn.m")>0)&&(n=n.replace(/qaapp.cn.m/i,"qaappm.cn"),n=n.replace(/preprod.cn.m/i,"preprodm.cn")),console.log(n),e=n+"m/special/teletext/index.html?id="+s,1==t&&$.ajax({url:"/api/internal/sas/ImageText/setClose",type:"post",dataType:"json",data:{id:s,short_url:e},success:function(e){1==e.code&&($(".publish-btn").attr("data-val",0),$(".publish-btn > span").html("发布"))},error:function(){console.log("出现异常")}}),0==t&&$.ajax({url:"/api/internal/sas/ImageText/setOpen",type:"post",dataType:"json",data:{id:s,short_url:e},success:function(e){1==e.code&&($(".publish-btn").attr("data-val",1),$(".publish-btn > span").html("下线"))},error:function(){console.log("出现异常")}})}),$(".preview-wrapper .close").on("click",function(){$(".preview-wrapper .preview").html(""),$("#qrCode").html(""),$(".qr .link p").html(""),$(".preview-wrapper").hide()}),$("#teletext-save").click(function(){var e=$("#teletext-content"),t=!0,a=i("id"),l={cover:"",title:"",author:"",intro:"",content:""};if(l.cover=e.find(".currenImg").attr("src"),l.title=e.find("[name='title']").val(),l.author=e.find("[name='author']").val(),l.intro=r.$txt.text()?r.$txt.text().substr(0,50):"",l.content=r.$txt.text()?r.$txt.html():"",a&&(l.id=a),t=n(l),!t)return alert("有必填项未填写"),!1;var s,o=e.find(".label-list ul").children(),c=[],d=[],p=$("#tele-skus").children(),u=[],m=$("body").data("preview"),f=m.split("activity/")[0];if((f.indexOf("qaapp.cn.m")>0||f.indexOf("preprod.cn.m")>0)&&(f=f.replace(/qaapp.cn.m/i,"qaappm.cn"),f=f.replace(/preprod.cn.m/i,"preprodm.cn")),o.length){var v=o.filter("li");$.each(v,function(e,t){c.push($(t).data("val")),d.push($(t).data("txt"))}),l.tags_id=c.join(),l.tags_name=d.join()}else l.tags_id="",l.tags_name="";if(p.length){var v=p.filter(".skus-item");$.each(v,function(e,t){u.push($(t).text())}),l.skus=u.join()}else l.skus="";l.jump_id=(new Date).getTime().toString(36),s=f+"m/special/teletext/index.html?id="+a,l.short_url=s,l.admin=$(".user-name").data("name"),$.ajax({url:"/api/internal/sas/ImageText/save",type:"post",dataType:"json",data:{data:JSON.stringify(l)},beforeSend:function(){$("#teletext-save").attr("disabled",!0),$("#teletext-save > span").text("正在保存")},success:function(e){1==e.code&&(alert("保存成功"),location.href="/teletext/list")},error:function(){console.error("出现异常")},complete:function(){$("#teletext-save > span").text("保存"),$("#teletext-save").attr("disabled",!1)}})}),$("#upload-img").click(function(){var e=$("#upload-img");return e.hasClass("disable")?!1:(e.addClass("disable"),void $(".teletext-row .upload-txt").html("正在上传"))}),$(".label-tags").on("click","li",function(){var e=$(this),t=e.data("val");$(this).addClass("current").siblings("li").removeClass("current"),a(t)}),$(".label-table").on("click","li",function(){var e=$(this),t=e.data("val"),a=e.text();e.hasClass("current")?($(".label-list ul li").filter("[data-val="+t+"]").remove(),e.removeClass("current")):(e.addClass("current"),$(".label-list ul").append("<li data-val="+t+" data-txt="+a+">"+a+"</li>"))}),$(".teletext-content").on("click",".del-prd",function(){var e=$(this),t=e.closest(".teletext-prd").data("val"),a=e.parents(".teletext-prd"),n=$("#tele-skus").children(".skus-item");a.remove(),$(n).each(function(e,a){var n=$(a).text();n==t&&$(a).remove()})}),$("#tele-skus").on("click",".del-prd",function(){var e=$(this),t=e.closest(".skus-item").text(),a=e.parents(".skus-item"),n=$(".teletext-content").find(".teletext-prd");a.remove(),$(n).each(function(e,a){var n=$(a).data("val");n==t&&$(a).remove()})})}();
Vue.config.delimiters=["${","}"],Vue.config.unsafeDelimiters=["{!!","!!}"];var vue=new Vue({el:"html",data:{matchTab:1,unMatchTab:1,subTab:1,key_match:[],key_unmatch:null,subscribe:null,unmatch_ruleId:null,subscribe_ruleId:null,materials:null,showKey_m:!1,showText:!1,showImg:!1,showVoice:!1,showVideo:!1,showNews:!1,replyT:"",UMreply:"",Sreply:"",newKey:"",select:{key:null,match:null,img:null,text:null,news:null,voice:null,video:null,unmatch:null,subscribe:null,tab:null},lastMaterial:{type:null,pageIndex:1,pageSize:10},count:{}},methods:{setTime:function(e){var t=new Date(1e3*e);return t=t.getFullYear()+"年"+(t.getMonth()+1)+"月"+t.getDate()+"日"},getMaterial:function(e,t){var a=this;$.ajax({url:"/api/wechat/offac/material",type:"get",dataType:"json",data:{type:e||"image",pageSize:a.count[e]||"10",pageIndex:"1"},success:function(e){a.materials=e.data.item,t&&t(e)}})},getReplay:function(){var e=this;$.ajax({url:"/api/wechat/getReply",type:"get",dataType:"json",success:function(t){t.data.key_match?(e.key_match=t.data.key_match,e.matchTab=t.data.key_match[0].reply_on):(e.key_match=[{keyword:[],reply_content:[],rule_id:(new Date).getTime().toString(36),title:"",open:!0,reply_type:1,reply_on:1}],e.matchTab=e.key_match[0].reply_on),t.data.key_unmatch&&t.data.key_unmatch.length>0?(e.key_unmatch=t.data.key_unmatch,e.unmatch_ruleId=t.data.key_unmatch[0].rule_id,e.unMatchTab=t.data.key_unmatch[0].reply_on):(e.key_unmatch=[{rule_id:(new Date).getTime().toString(36),title:"",keyword:null,reply_content:{},reply_type:2,reply_on:1}],e.unmatch_ruleId=e.key_unmatch[0].rule_id,e.unMatchTab=e.key_unmatch[0].reply_on),t.data.subscribe&&t.data.subscribe.length>0?(e.subscribe=t.data.subscribe,e.subscribe_ruleId=t.data.subscribe[0].rule_id,e.subTab=t.data.subscribe[0].reply_on):(e.subscribe=[{rule_id:(new Date).getTime().toString(36),title:"",keyword:null,reply_content:{},reply_type:3,reply_on:1}],e.subscribe_ruleId=e.subscribe[0].rule_id,e.subTab=e.subscribe[0].reply_on)}})},getMaterialCount:function(){$this=this,$.ajax({url:"/api/wechat/offac/materialCount",type:"get",dataType:"json",success:function(e){$this.count={image:e.data.image_count,news:e.data.news_count,voice:e.data.voice_count,video:e.data.video_count}}})},filterRC:function(e,t){var a=t.filter(function(t){return t.type==e});return a.length},changeTag:function(e){e.match_tag=1==e.match_tag?0:1},changeMatch:function(e){var t=e.open?!1:!0;Vue.set(e,"open",t)},filterRT:function(e){var t=this;1==e.reply_type?t.select.match=e:2==e.reply_type?t.select.unmatch=e:t.select.subscribe=e},saveTabNum:function(e){var t=this;t.select.tab=e},editReply:function(e){var t=this;3==t.select.tab?t.select.subscribe.reply_content=e:2==t.select.tab?t.select.unmatch.reply_content=e:t.select.match.reply_content.push(e)},shutdown:function(){var e=this;if(confirm("关闭自动回复之后，将立即对所有用户生效。确认关闭？"))if(3==e.select.tab){var t={subscribe:JSON.stringify(e.subscribe[0]),reply_on:0};$.ajax({url:"/api/wechat/reply/save",type:"post",dataType:"json",data:t,success:function(){e.subTab=0,alert("停用成功")}})}else if(2==e.select.tab){var t={key_unmatch:JSON.stringify(e.key_unmatch[0]),reply_on:0};$.ajax({url:"/api/wechat/reply/save",type:"post",dataType:"json",data:t,success:function(){e.unMatchTab=0,alert("停用成功")}})}else{var t={key_match:JSON.stringify(e.key_match),reply_on:0};$.ajax({url:"/api/wechat/reply/save",type:"post",dataType:"json",data:t,success:function(){e.matchTab=0,alert("停用成功")}})}},reopen:function(){var e=this;if(3==e.select.tab){var t={subscribe:JSON.stringify(e.subscribe[0]),reply_on:1};$.ajax({url:"/api/wechat/reply/save",type:"post",dataType:"json",data:t,success:function(){e.subTab=1,alert("开启成功")}})}else if(2==e.select.tab){var t={key_unmatch:JSON.stringify(e.key_unmatch[0]),reply_on:1};$.ajax({url:"/api/wechat/reply/save",type:"post",dataType:"json",data:t,success:function(){e.unMatchTab=1,alert("开启成功")}})}else{var t={key_match:JSON.stringify(e.key_match),reply_on:1};$.ajax({url:"/api/wechat/reply/save",type:"post",dataType:"json",data:t,success:function(){e.matchTab=1,alert("开启成功")}})}},addM:function(){var e={keyword:[],reply_content:[],rule_id:(new Date).getTime().toString(36),title:"",open:!0},t=this;t.key_match.length<10?t.key_match.push(e):alert("最多只能设置10条规则")},addKey:function(e){var t=this;t.showKey_m=!0,t.newKey="",t.select.key=null,t.select.match=e},saveKey:function(){var e=this;e.select.key?Vue.set(e.select.key,"key",e.newKey):e.select.match.keyword.length<10?e.select.match.keyword.push({key:e.newKey,match_tag:0}):alert("最多设置10个关键词"),e.showKey_m=!1},editKey:function(e){var t=this;t.showKey_m=!0,t.newKey=e.key,t.select.key=e},saveMatch:function(e){var t=this;e.open=!1,0!=e.keyword.length&&e.title&&0!=e.reply_content.length?$.ajax({url:"/api/wechat/reply/save",type:"post",dataType:"json",data:{key_match:JSON.stringify(t.key_match),reply_on:t.matchTab},success:function(e){alert(e.msg)}}):(alert("请确认填写无误后再保存"),e.open=!0)},saveUnmatch:function(e){var t=this;$.ajax({url:"/api/wechat/reply/save",type:"post",dataType:"json",data:{key_unmatch:JSON.stringify(e),reply_on:t.unMatchTab},success:function(e){alert(e.msg)}})},saveSubscribe:function(e){var t=this;$.ajax({url:"/api/wechat/reply/save",type:"post",dataType:"json",data:{subscribe:JSON.stringify(e),reply_on:t.subTab},success:function(e){alert(e.msg)}})},checkReplyNum:function(e){return!e.reply_content.length||e.reply_content.length<5?!0:!1},replyText:function(e,t){var a=this;a.checkReplyNum(e)||t?(a.select.match=e,a.select.text=t,a.replyT=t?t.content:"",a.showText=!0):alert("最多添加5条回复内容")},replyImg:function(e){var t=this;t.checkReplyNum(e)?(t.filterRT(e),t.getMaterial("image",function(){t.showImg=!0})):alert("最多添加5条回复内容")},replyVoice:function(e){var t=this;t.checkReplyNum(e)?(t.filterRT(e),t.getMaterial("voice",function(){t.showVoice=!0})):alert("最多添加5条回复内容")},replyVideo:function(e){var t=this;t.checkReplyNum(e)?(t.filterRT(e),t.getMaterial("video",function(){t.showVideo=!0})):alert("最多添加5条回复内容")},replyNews:function(e){var t=this;t.checkReplyNum(e)?(t.filterRT(e),t.getMaterial("news",function(){t.showNews=!0})):alert("最多添加5条回复内容")},removeByIndex:function(e,t){t.splice(e,1)},removeRule:function(e,t,a){t.splice(e,1),$.ajax({url:"/api/wechat/reply/del",type:"post",dataType:"json",data:{key_match:JSON.stringify(a)},success:function(e){alert(e.msg)}})},selectImg:function(e){this.select.img={type:"image",content:e.media_id,name:e.name,url:e.url}},selectAudio:function(e){this.select.voice={type:"voice",content:e.media_id,name:e.name,update_time:e.update_time}},selectVideo:function(e){this.select.video={type:"video",content:e.media_id,name:e.name,update_time:e.update_time}},selectNews:function(e){this.select.news={type:"news",content:{Title:e.content.news_item[0].title,Description:e.content.news_item[0].digest,PicUrl:e.content.news_item[0].thumb_url,Url:e.content.news_item[0].url},media_id:e.media_id,update_time:e.update_time}},checkImg:function(){var e=this;e.editReply(e.select.img),e.showImg=!1},checkVoice:function(){var e=this;e.editReply(e.select.voice),e.showVoice=!1},checkVideo:function(){var e=this;e.editReply(e.select.video),e.showVideo=!1},checkNews:function(){var e=this;e.editReply(e.select.news),e.showNews=!1},saveText:function(){var e=this;e.select.text?e.select.text.content=e.replyT:e.select.match.reply_content.push({type:"text",content:e.replyT}),e.showText=!1},saveUText:function(e){var t=this;t.select.unmatch=e,t.select.unmatch.reply_content={type:"text",content:t.UMreply},t.saveUnmatch(e)},saveSText:function(e){var t=this;t.select.subscribe=e,t.select.subscribe.reply_content={type:"text",content:t.Sreply},t.saveSubscribe(e)}},created:function(){var e=this;e.getReplay(),e.getMaterialCount()}});
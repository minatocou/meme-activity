!function(){template.config("openTag","${"),template.config("closeTag","}");var t="#canvas",i="#template",e=".img-list",a=".attr-form",n=".comm-attr",o="data-setting",s={l1:".t1-attr",img:".img-attr",video:".video-attr"},r=i18n[$("body").data("localize")],l={l1:{column:3}},c=function(){return(new Date).getTime().toString(36)},d=function(){},p=function(i){var e=$(t).find(".cur");e.css("background",i.videoBackground),e.find("img").attr("src",i.imgSrc)},g=function(i){var e=$(t).find(".cur");e.find("a").attr("href",i.imgUrl),e.find("img").attr("src",i.imgSrc)},u=function(i){var e=$(t).find(".cur"),a=JSON.parse(e.attr(o));i=_.extend(a,i),e.attr(o,JSON.stringify(i));var n={l1:d,img:g,video:p};n[i.type](i)},m=function(){var t={},i=$(n).serializeObject();t.root=i;var e=$("[data-setting]"),a=[];return e.each(function(t){var i=$(this),e=i.width(),n=i.height(),o=i.find(".link"),s=i.find(".addVideo-cont"),r=JSON.parse(i.attr("data-setting"));if(r.position=t,o.length>0){var l=[];o.each(function(){var t={css:{left:(parseInt($(this).css("left"))/e*100).toFixed(2)+"%",top:(parseInt($(this).css("top"))/n*100).toFixed(2)+"%",width:($(this).width()/e*100).toFixed(2)+"%",height:($(this).height()/n*100).toFixed(2)+"%",position:"absolute",zIndex:"100"},url:$(this).find(".link-url").text()};l.push(t)}),r.links=l}else delete r.links;if(i.hasClass("tVideo")){if(s.length>0){var c={left:parseInt(s.css("left"))/e*100+"%",top:parseInt(s.css("top"))/n*100+"%",width:s.width()/e*100+"%",height:s.height()/n*100+"%",position:"absolute",zIndex:"100"};r.videocss=c}else delete r.videocss,delete r.videoUrl;r.videoBackground=r.videoBackground||"/img/video.png"}a.push(r)}),t.field=a,t},f=function(t,i){var e=m();""!=$.trim(e.root.title)?$.post("/api/pc/save",{cid:e.root.cid,d:e.root.d,title:e.root.title,key:e.root.urlkey,setting:JSON.stringify(e),state:$("body").data("state")},function(i){t&&t(i,e)}):(i.removeClass("disable"),alert(r.activity_none))};$("#save-btn").on("click",function(){$(this).hasClass("disable")||($(this).addClass("disable"),f(function(){alert(r.save_success),window.location.reload()},$(this)))}),$(i).sortable({group:{name:"template",pull:"clone"},sort:!0,fallbackOnBody:!0}),$(e).sortable({group:{name:"img",pull:"clone"},fallbackOnBody:!0}),$(t).sortable({group:{name:"canvas",put:["template","img"],draggable:"[data-field]"},sort:!0,onUpdate:function(){console.log(123)},onAdd:function(t){var i=$(t.item),e=$(t.item).attr("data-field"),a={id:c(),type:i.attr("data-field")};console.log(e),i.attr("chosenimg")&&(a.imgSrc=i.attr("chosenimg")),l[e]&&(a=_.extend(a,l[e])),$(t.item).attr("id",a.id).attr(o,JSON.stringify(a))}}),$(".link").each(function(){$(this).resizable({containment:$(this).closest("li")}).draggable({containment:$(this).closest("li")})}),$("#addLink").click(function(){var i=$(t).find(".cur"),e=$('<div class="link"><span class="link-url">'+$("#linkUrl").val()+'</span><i class="close-link-btn">×</i></div>').appendTo(i);e.resizable({containment:i}).draggable({containment:i})}),$.fn.serializeObject=function(){var t={},i=this.serializeArray();return $.each(i,function(){void 0!==t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t},$(t).on("click",".close-btn",function(t){t.stopPropagation(),t.preventDefault(),$(a).hide(),$(this).closest("li").remove()}),$(t).on("click",".close-link-btn",function(t){t.stopPropagation(),t.preventDefault(),$(this).closest(".link").remove()}),$(t).on("click",".close-video-btn",function(t){t.stopPropagation(),t.preventDefault(),$(this).closest(".addVideo-cont").remove()}),$(t).on("click","[data-field]",function(t){t.stopPropagation(),t.preventDefault();var i=$(this);i.addClass("cur").siblings(".cur").removeClass("cur");var e=i.attr("data-field"),n=s[e];$(n).show().siblings(a).hide();var r=JSON.parse(i.attr(o));$(n).find("input").val(""),console.log($(n).find("input[name$='imgSrc']").length),$(n).find("input[name$='imgSrc']").each(function(){$(this).val(i.attr("chosenimg"))});for(var l in r)r[l]&&$(n).find("[name="+l+"]").val(r[l])}),$(a).on("change","input,select",function(){var t=$(this).closest("form").serializeObject();u(t)}),$("#preview-btn").on("click",function(){f(function(t,i){var e=i.root.urlkey,a=$("body").data("preview")+e+"?preview=1";window.open(a)},$(this))}),$(".img-wrapper").on("click","li img",function(){$(this).addClass("chosen");var i=$(this).attr("src"),e=$(t).find(".cur");if(e.length>0){e.attr("chosenimg",i);var a=$("form:visible");a.find("[form-img]").val(i);var n=a.serializeObject();u(n)}});var v=WebUploader.create({auto:!0,server:"/imageuploader/primary",pick:"#upload-img",accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},formData:{size:[120,240]}});v.option("compress",{quality:100,allowMagnify:!1,crop:!1,preserveHeaders:!0,noCompressIfLarger:!1});var h;v.on("uploadStart",function(){$("#upload-img i").addClass("fa-spinner")}),v.on("uploadSuccess",function(t,i){{var e=JSON.parse(i._raw);t.name.replace(".jpg","")}return $("#upload-img i").removeClass("fa-spinner"),1!=e.code?void alert(e.msg[0]):void(e.data&&(h=e.data.img,$(".img-list").prepend('<li chosenimg="'+h+'" class="tImg template" data-field="img"><a style="pointer-events: none;"><img src='+h+' alt=""> </a><i class="close-btn">×</i></li>'),$.ajax({url:"/api/picture/save",type:"post",dataType:"json",data:{imgsrc:h},success:function(t){console.log(t)},error:function(t){console.log(t)}})))}),jQuery(document).ready(function(t){t.ajax({url:"/api/picture/getimg",type:"get",dataType:"json",success:function(i){for(var e=0;e<i.length;e++)t(".img-list").prepend('<li chosenimg="'+i[e].url+'" class="tImg template" data-field="img"><a style="pointer-events: none;"><img src='+i[e].url+' alt=""> </a><i data-id="'+i[e].id+'" class="close-btn">×</i></li>')}})}),$(".addVideo-cont").each(function(){$(this).resizable({containment:$(this).closest("li")}).draggable({containment:$(this).closest("li")})}),$("#addVideo").click(function(){var i=$(t).find(".cur");if(i.find(".addVideo-cont").length)return alert(r.video_one),!1;if(!$.trim($("#videoUrl").val())||!$.trim($("#videoBackground").val()))return alert(r.video_bk),!1;var e=$('<div class="addVideo-cont"><span class="video-url">'+$("#videoUrl").val()+'</span><i class="close-video-btn">×</i></div>').appendTo(i);e.resizable({containment:i}).draggable({containment:i})}),$(".img-list").on("click",".close-btn",function(){var t=$(this).attr("data-id");$.ajax({url:"/api/picture/del",type:"post",dataType:"json",data:{id:t}}),$($(this).parent()).css("display","none")}),$(".ba").click(function(){var t=this;$(t).hasClass("toggle")?$(".img-wrapper").animate({left:"-75px"},function(){$(t).removeClass("toggle")}):$(".img-wrapper").animate({left:"169px"},function(){$(t).addClass("toggle")})})}();
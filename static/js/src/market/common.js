function toLastSecondOfDate(t){var e=new Date,n=+e;e.setDate(e.getDate()+1),e.setSeconds(e.getSeconds()-1);var a=+e,i=a-n,o=t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate();return new Date(+new Date(o)+i)}function checkTime(){var t=$("#from_date").val().trim(),e=$("#to_date").val().trim();return console.log(moment(t).isBefore(e)),""==t||""==e?!0:t==e?!0:moment(e).isBefore(t)?(alert("开始时间要小于或等于结束时间"),!1):!0}function checkNonEmpty(){var t=!0;return $(".non-empty input").each(function(){return""==this.value.trim()&&"none"!=$(this).parents(".non-empty").css("display")?(alert(($(this).siblings("label").html()||$(this).parent().siblings("label").html())+"不能为空"),t=!1,!1):void 0}),t&&""==$("textarea").val()?(alert(document.getElementById("sku_list")?"请输入SKU":"请输入Category"),!1):t}function searchContent(){var t={id:$("#activityId").val().trim(),name:$("#activityName").val().trim(),timeWay:$("input[name='selectTime']:checked").val(),time:[$("#startTime").val(),$("#endTime").val()],type:$("#activityType").val(),state:$("#activityState").val()};return t}function getSearch(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),n=decodeURIComponent(window.location.search).substr(1).match(e);return null!=n?n[2]:null}function MarketList(t,e,n){this.url=CONFIG.dev.domain+t,this.tpl=e||Handlebars.compile($("#listTpl").html()),this.element=n||$("#list"),this.page=getSearch("page")||1}function MarketDetail(t,e,n){this.url=CONFIG.dev.domain+t,this.tpl=e||Handlebars.compile($("#detailTpl").html()),this.element=n||$("#detail")}function MarketDelete(t){$("#list").on("click",".btn-danger",function(){var t=$(this).parents("tr").data("id");$("#myModal").data("id",t)}),$("#sureBtn").click(function(){$.ajax({url:CONFIG.dev.domain+t+"?id="+$("#myModal").data("id"),type:"POST",dataType:"json",success:function(t){alert(t.msg),"1"==t.code&&location.reload()},error:function(t){console.log(t)}})})}function getQty(){for(var t=this.value.split(/,|，/),e={},n="",a=0,i=t.length;i>a;a++){var o=t[a].trim();e[o]?e[o]++:""!=o&&(e[o]=1)}for(var o in e)n+=o+":"+e[o]+"件 ";$(this).parents(".group").find("p").html(n),console.log(n,e)}function discountChange(t){var e;if(document.getElementById("discount"))if(e=[["件 - 共","元","1）产品price*N≥N元购金额  2）最少件数需≥1"],["件 - 减","元","1）最少件数需≥1   2）设置N见立减X元时，产品price*N≥立减金额"],["元 - 减","元","条件金额≥减扣金额"],["件 - 打","折","1）最少件数需≥1   2)  打折数值格式：8.5折—输入8.5   9折-输入9"],["元 - 打","折","打折数值格式：8.5折输入8.5 （英文.）   9折输入9"],"",["件-再以","元／件"],["元-再以","元／件"],["件，赠","件赠品，赠品为"],["元，赠","件赠品，赠品为"]],$("#discount .s1")&&$("#discount .s1").html(e[t][0]),$("#discount .s2")&&$("#discount .s2").html(e[t][1]),$("#discount").removeClass("hall-gift"),5>t)$("#discount .prompt").css({display:"inline"}),$("#discount .prompt").html(e[t][2]),$("#discount .change-sale").css({display:"none"});else if(6==t||7==t)$("#discount .prompt").css({display:"none"}),$("#discount .change-sale").css({display:"inline-block"}),$("#discount .ex").css({display:"inline"});else if(8==t||9==t){$("#discount").addClass("hall-gift"),$("#discount .prompt").css({display:"none"}),$("#discount .ex").css({display:"none"}),$("#discount .change-sale").css({display:"inline-block"});for(var n=0;3>n&&""!=$(".hall-gift-sku")[n].value.trim();n++)getQty.call($(".hall-gift-sku")[n]);$(".sku-list").each(function(t,e){$(e).find('input[type="radio"]').attr("checked",!0),$(e).find('input[type="text"]').attr("readonly",!1)}),$(".category-list").each(function(t,e){$(e).find('input[type="text"]').attr("readonly",!0)})}document.getElementById("discountCoupon")&&(e=[null,["元 - 减","元"],["元 - 打","折"]],$("#discountCoupon .s1")&&$("#discountCoupon .s1").html(e[t][0]),$("#discountCoupon .s2")&&$("#discountCoupon .s2").html(e[t][1]))}function changeStatus(t){$("#pauseBtn").click(function(){var e=$("#myModalPause").data("id");$.ajax({url:CONFIG.dev.domain+t,type:"POST",dataType:"json",data:{id:e,status:2},success:function(t){alert(t.msg),location.reload()},error:function(t){console.log(t)}})}),$("#list").on("click",".change-status",function(){var e=$(this).data("status"),n=$(this).data("id");return 2==e?void $("#myModalPause").data({id:n}):void $.ajax({url:CONFIG.dev.domain+t,type:"POST",dataType:"json",data:{id:n,status:e},success:function(t){alert(t.msg),location.reload()},error:function(t){console.log(t)}})})}function checkDiscount(){for(var t=[],e=[],n=$("#discount input").length,a=2;n>a;a++)if(""!=$("#discount input")[a].value.trim()){if($("#discount input")[a].value.trim()<0)return alert("设置优惠填写有误"),!1;t[a-2]=1,e[a-2]=1}else t[a-2]=0;return e.length%2==0&&t.toString()==t.sort(function(t,e){return e-t}).toString()?!0:(alert("设置优惠填写有误"),!1)}var CONFIG={dev:{domain:$(".header-container").data("coupon")}};$(document).ajaxStart(function(){$(".ajax-loading-backdrop").show()}).ajaxStop(function(){$(".ajax-loading-backdrop").hide()}),$.ajaxSetup({cache:!1});var dateTimePickerInit=function(){laydate({elem:"#from_date",format:"YYYY-MM-DD hh:mm:ss",istime:!0,istoday:!0,choose:function(t){console.log(t)}});var t=!!$("#to_date").val();laydate({elem:"#to_date",format:t?"YYYY-MM-DD hh:mm:ss":"YYYY-MM-DD 23:59:59",istime:!0,istoday:!0,choose:function(){console.log(arguments),t?void 0:this.format="YYYY-MM-DD hh:mm:ss"}})},dateFormat=function(t,e){t=new Date(t);var n={M:t.getMonth()+1,d:t.getDate(),D:t.getDate(),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds(),q:Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};return e=e.replace(/([y|YMd|DhmsqS])+/g,function(e,a){var i=n[a];return void 0!==i?(e.length>1&&(i="0"+i,i=i.substr(i.length-2)),i):"y"===a.toLowerCase()?(t.getFullYear()+"").substring(4-e.length):e})};$("#spreadSwitch").on("click","span",function(){$("#explainText").toggle(300,function(){$("#spreadSwitch").toggleClass("up")})}),$("#logBtn").on("click","span",function(){$("#logTable").toggle(300,function(){$("#logBtn").toggleClass("up")})}),MarketList.prototype.getList=function(t){var e=this,n=t||{page:e.page,size:10};$.ajax({url:e.url,type:"GET",dataType:"json",data:n,success:function(t){0==t.code&&alert(t.msg);var n=t.data.list;n&&0!=n.length?(e.element.html(e.tpl(n)),e.renderPages(parseInt(t.data.total),10,e.page)):(e.element.html('<tr colspan="6"><td colspan="6">没有内容</td></tr>'),e.renderPages(1,1,1))},error:function(t){console.log(t)}})},MarketList.prototype.renderPages=function(t,e,n){$("#pagination-container").pagination({dataSource:new Array(t),pageSize:e,showGoInput:!0,showGoButton:!0,pageNumber:n,afterPageOnClick:function(t,e){location.href="?page="+e.trim()},afterPreviousOnClick:function(t,e){location.href="?page="+e.trim()},afterNextOnClick:function(t,e){location.href="?page="+e.trim()},afterGoButtonOnClick:function(t,e){var n=e.trim();""!=n&&(location.href="?page="+n)},callback:function(){}})},MarketDetail.prototype.getDetail=function(){var t,e,n=this;getSearch("id")?$.ajax({url:n.url,type:"GET",dataType:"json",data:{id:getSearch("id")},success:function(a){0==a.code&&alert(a.msg),t=a.data,n.is_generated=t.is_generated,t.discount&&(t.discount=JSON.parse(t.discount)),t.category&&(t.category=JSON.parse(t.category)),console.log(t),e=Handlebars.compile($("#detailTpl").html()),$("#detail").html(e(t)),dateTimePickerInit(!1,!0),t.discount_type&&discountChange(t.discount_type),t.type&&discountChange(t.type),t.type<=4?$("#discount .change-sale").each(function(){$($(this).find("input[type='radio']")[0]).attr("checked","checked"),$($(this).find("input[type='radio']")[0]).next("input").attr("readonly",!1)}):6==t.type||7==t.type?$("#discount .change-sale").each(function(){var t=$(this).find("input[type='radio']:checked"),e=$(this).find("input[type='text']")[t.val()-1];$(e).attr("readonly",!1),0==t.length&&($($(this).find("input[type='radio']")[0]).attr("checked",!0),$($(this).find("input[type='text']")[0]).attr("readonly",!1))}):(8==t.type||9==t.type)&&$("#discount .change-sale").each(function(){var t=$(this).find("input[type='radio']:checked"),e=$(this).find("input[type='text']")[t.val()-1];$(e).attr("readonly",!1),0==t.length&&($($(this).find("input[type='radio']")[0]).attr("checked",!0),$($(this).find("input[type='text']")[0]).attr("readonly",!1))})},error:function(t){console.log(t)}}):(e=Handlebars.compile($("#detailTpl").html()),$("#detail").html(e()),dateTimePickerInit(!1,!0),$("#discount .change-sale").css({display:"none"}),$("#discount .change-sale").each(function(){$($(this).find("input[type='radio']")[0]).attr("checked","checked"),$($(this).find("input[type='radio']")[0]).next("input").attr("readonly",!1)}))};var HistoryLog={getList:function(t,e){var n=this;$.ajax({url:CONFIG.dev.domain+"/"+n.type+"/history",type:"GET",data:{related_id:n.id,size:t,page:e},dataType:"json",success:function(a){0==a.code&&alert(a.msg);var i=a.data,o=Handlebars.compile($("#logTpl").html());return 0==i.list.length?void $(".log").remove():($("#logTbody").html(o(i)),void n.renderPages(parseInt(i.total),t,e))},error:function(t){console.log(t)}})},renderPages:function(t,e,n){var a=this;$("#pagination-container").pagination({dataSource:new Array(t),pageSize:e,showGoInput:!0,showGoButton:!0,pageNumber:n,afterPageOnClick:function(t,n){a.getList(e,n)},afterPreviousOnClick:function(t,n){a.getList(e,n)},afterNextOnClick:function(t,n){a.getList(e,n)},afterGoButtonOnClick:function(t,n){a.getList(e,n)},callback:function(){}})},init:function(t,e){this.id=t,this.type=e,this.getList(5,1)}};$("#detail").on("change","#type",function(){var t=$(this).val();console.log(t),discountChange(t)}),$("#detail").on("change","#discount_type",function(){var t=$(this).val();console.log(t),discountChange(t)});
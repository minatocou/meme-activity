function appendOption(t){var a="";return Object.keys(t).forEach(function(e){a+='<option value="'+e+'">'+t[e]+"</option>"}),a}function showPage(t,a){var e=a?$.extend(t.form.data().submitParam,a):t.form.data().submitParam;t=a?$.extend(t,a):t,ajaxReq({url:t.form[0].getAttribute("data-api"),data:e}).then(function(a){if("undefined"!=typeof a){a=a.data,initPager($.extend(t,{totalCount:a.totalNum,pageSize:e.pageSize}));var n={list:[].concat(a.taskList)};n.list.status=statusText,n.list.forEach(function(t){t.dataStringify=JSON.stringify(t)}),t.dataContainer.html(parseTmpl({data:n,id:t.id}))}})}function validateCount(){var t=this,a=$.makeArray(t.find(".totalCount.item-input-fix")),e=$('[data-bind=".totalCount"]'),n=a.some(function(t){return Number(t.value)!==Number(e.val())});return n?(tipsShow(localeI18n.boxCountIsNotAllow,t.closest(".modal-dialog")),t.css("border","1px solid red"),!1):(t.css("border",""),!0)}!function(t){var a=function(t,a){t=new Date(t);var e={M:t.getMonth()+1,d:t.getDate(),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds(),q:Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};return a=a.replace(/([yMdhmsqS])+/g,function(a,n){var i=e[n];return void 0!==i?(a.length>1&&(i="0"+i,i=i.substr(i.length-2)),i):"y"===n?(t.getFullYear()+"").substring(4-a.length):a})},e={"add-assemble-task":{action:"/task/add",title:localeI18n.createAssembleTask,btnName:localeI18n.save,hiddenFunc:function(){showPage(t("form.search-form[data-api]:visible").data().pageParam)},showFunc:function(){var a=t(this);ajaxReq({url:"/task/boxlist"}).then(function(t){if("undefined"!=typeof t){for(var e=t.data,n="",i=0;i<e.length;i++)n+='<option value="'+e[i].sku+'">'+e[i].name+"</option>";var o=a.find('form select[name="boxSku"]').html(n).change();setTimeout(function(){o.selectpicker()},300)}});t(this).find("form").validate({submitHandler:function(a){var e=t(a),n=[];if(e.find(".item-cell-container").each(function(a,e){return validateCount.call(t(e))?void n.push(!0):!0}),!(n.length<e.find(".item-cell-container").length)){var i=[],o=e.find('[name="showType"]:checked').val().toLowerCase();e.find(".item-cell-container").each(function(a,e){var n=[];i.push(n),t(e).children().not(":last").each(function(a,e){var i={};0!==Number(t(e).find("[data-calc]").val())&&(i[o]=t(e).find("[data-sku]").val(),i.qty=t(e).find("[data-calc]").val(),n.push(i))})});var d=e.find(".form-group :input").serializeObject(),r={};i.forEach(function(t,a){r[a+1]=t}),d.content=JSON.stringify(r),d.prodType=o[0].toUpperCase(),ajaxReq({url:a.getAttribute("action"),type:"POST",data:d}).then(function(t){if("undefined"!=typeof t){var a=e.closest(".modal");tipsShow(localeI18n.addSuccess,a.find(".modal-dialog")),e.trigger("reset"),setTimeout(function(){a.modal("hide")},2700)}})}}})}}};t("body").on("click",'[data-toggle="modal"][data-modal]',function(){var a=this.getAttribute("data-modal"),n={id:"modal-template",data:{subModal:'${include "'+(e[a].equalsTo?e[a].equalsTo:a)+'"}',modalTitle:e[a].title,btnName:e[a].btnName}};e[a].otherInfo&&(n.data[e[a].otherInfo]=!0);var i=parseTmpl(n);initModal(t(parseTmpl({tmpl:i,data:{action:e[a].action}})).data({target:this}),{show:e[a].showFunc,hidden:e[a].hiddenFunc})}),t("body").on("click","[data-delete-sku][data-url]",function(){t(this);confirm(localeI18n.confirmOperation)&&ajaxReq({url:this.getAttribute("data-url"),type:"POST",data:{sku:this.getAttribute("data-delete-sku")}}).then(function(a){"undefined"!=typeof a&&(tipsShow(a.msg,t("body")),showPage(t("form.search-form[data-api]:visible").data().pageParam))})}).on("change",'select[name="boxSku"]',function(){var t=this;initBoxAssemble.call(t,"showItemDetail2",{sku:t.value})}).on("click","[data-taskId][data-key]",function(){var a={};a[this.getAttribute("data-key")]=this.getAttribute("data-taskId"),confirm(localeI18n.confirmOperation)&&ajaxReq({url:this.getAttribute("data-url"),data:a,type:"POST"}).then(function(a){"undefined"!=typeof a&&showPage(t("form.search-form[data-api]:visible").data().pageParam)})}).on("submit",".scan-submit-form",function(){var e=t(this);return ajaxReq({url:this.getAttribute("data-api"),type:"POST",data:t(this).serializeObject()}).then(function(n){if("undefined"!=typeof n){var i=a(new Date,"yyyy年 MM月 dd日 hh:mm:ss"),o=[{scanUser:t(".record-user-name").text(),count:Math.abs(t('[name="qty"]:visible').val().trim()||1),boxCode:t('[name="barCode"]:visible').val().trim(),scanDate:i}];e.closest(".tab-pane").find(".data-container").prepend(parseTmpl({data:{list:o},id:"storage-list-tmpl"})),e[0].qty.value=e[0].qty.min,e.find('[name="barCode"]').focus().select()}}),!1}).on("change","input.item-input-fix[data-calc]",function(){var a=t(this);if(!/^(0|[1-9][0-9]*)$/g.test(this.value))return this.value=0,void a.change();var e=a.closest(".item-input-container"),n=t.makeArray(e.find("[data-calc]")),i=n.map(function(t){return Number(t.value)}).reduce(function(t,a){return t+a});e.find(this.getAttribute("data-calc")).val(i),Number(t('[data-bind=".totalCount"]').val())===i&&a.closest(".item-cell-container").css("border","")})}(jQuery);var statusText={0:localeI18n.newCreated,1:localeI18n.BillHasPrinted,2:localeI18n.barCodeHasPrinted,3:localeI18n.allHavePrinted,4:localeI18n.hasCompleted};$('select[name="status"]').append(appendOption(statusText)),$("#query-component-modal").on("show.bs.modal",function(t){var a=$(this).data({taskId:t.relatedTarget.getAttribute("data-taskId")}).find('[data-toggle="tab"]').eq(0).click().end().end().find("[data-req][data-url]"),e="?"+$.param({taskId:t.relatedTarget.getAttribute("data-taskId"),operator:$(".record-user-name").text()});a.each(function(t,a){a.setAttribute("href",APIHOST+a.getAttribute("data-req")+e)})}).on("hidden.bs.modal",function(){$(this).find('[name="showType"]').eq(1).click(),showPage($("form.search-form[data-api]:visible").data().pageParam)}),$("body").on("change",'[name="showType"]',function(){var t=this;$(t).closest(".modal").find(".item-input").each(function(a,e){e.value=$(e).data()[t.value]||""})}).on("change",'[name="prodType"]',function(){var t=this.value.toLowerCase();$("#modal-frame [data-sku][data-barcode]").each(function(){this.type="barcode"===t?"number":"text",this.value=this.getAttribute("data-"+t)})}),$("body").on("click",".add-new-line",function(){var t=$(this);$(this.getAttribute("data-clone")).eq(0).clone().val("").prop("readonly",!1).attr("data-sku","").attr("data-barcode","").appendTo(t.parent().siblings(this.getAttribute("data-target")))}).on("click",".remove-one-line",function(){var t=$(this),a=t.parent().siblings(this.getAttribute("data-target")).children();a.length>1?a.eq(-1).remove():tipsShow(localeI18n.lastOnecantRemove,t.closest(".modal-dialog"))}),$("body").on("change",'[data-bind=".totalCount"]',function(){var t=this,a=$(t).closest(".modal").find(".item-input-container").map(function(){return 1===$(this).find("[data-calc]").length?$(this).find("[data-calc]")[0]:void 0});a.each(function(){$(this).val(t.value).change()})}),$("body").on("click",".tab-box-item",function(){var t=this.getAttribute("data-tmpl");ajaxReq({url:this.getAttribute("data-api"),data:{taskId:$(this).closest(".modal").data("taskId")}}).then(function(a){if("undefined"!=typeof a){var e=formatList(a.data,t),n={};n[t]=e,setTimeout(function(){$("#query-component-modal").find(".tab-pane.active .data-container").html(parseTmpl({id:"item-detail-tmpl",data:n})),"showBill"===t&&(delete a.data[0],$("#query-component-modal").find("[data-bind]").each(function(t,e){e.innerHTML=a.data[e.getAttribute("data-bind")]||localeI18n.none}))})}})});
function getRelatedData(){return ajaxReq({url:"/sas/attribute/list"}).then(function(t){return dataCache=t.data,t})}function getRelatedDataAndShowList(t,e){t=t||function(){},e=e||{},getRelatedData().then(function(t){return relatedProperty(t,e.attribute_id),t}).then(function(){t(e)})}function createItem(t,e){$(".question-option-list")[e||"html"](parseTmpl({id:"option-item-tmpl",data:t||{}}))}function relatedProperty(t,e){for(var a="",i=0;i<t.data.length;i++)a+='<option data-id="'+t.data[i].attribute_id+'" value="'+t.data[i].type+'">'+t.data[i].title+"</option>";var n=$('[name="relatedProperty"]');return n.show().html(a),n.find('[data-id="'+e+'"]').length&&n.find('[data-id="'+e+'"]').prop("selected",!0).end().change()||n.change(),t.data}function validateAndGetQuestionData(){var t=$(".question-setting-container input").toArray().some(function(t){return t.focus(),""===t.value.trim()});if(t)return void alert("请把题目相关信息填写完整！");var e={type:$('[name="type"]:checked').val(),title:$('[name="questionTitle"]').val(),is_required:$('[name="is_required"]:checked').val()||0,attribute_id:$('[name="relatedProperty"]:visible')[0]?$('[name="relatedProperty"]:visible')[0].selectedOptions[0].getAttribute("data-id"):""},a=[];return $('[name="optionTag"]').each(function(t,e){var i={tag_id:e.getAttribute("data-tag-id")||"",value:e.value};e.getAttribute("data-option-id")&&(i.option_id=e.getAttribute("data-option-id")),a.push(i)}),e.options=a,e}function createQuestionPreviewItem(t,e){var a=[].concat(t);a.forEach(function(t){t.dataStringify=JSON.stringify(t)}),!e&&$(".question-preview-list").append(parseTmpl({id:"question-preview-tmpl",data:{data:a}}))||e(a),$(".related-or-not").prop("checked",!1).change(),setTimeout(function(){$("[data-tmpl-id]").eq(0).click().change()})}function validateUrl(t){var e=/^((http|https):\/\/)?(\w(\:\w)?@)?([0-9a-z_-]+\.)*?([a-z0-9-]+\.[a-z]{2,6}(\.[a-z]{2})?(\:[0-9]{2,6})?)((\/[^?#<>\/\\*":]*)+(\?[^#]*)?(#.*)?)?$/i,a=$('#outside-chain [name="url"]:visible');return a.length?e.test(a.val())?t?{url:a.val()}:void saveQuestionnaire({url:a.val()}):(alert("请输入正确的外部链接"),void a.focus()):!0}function getQuestionnaireDataAndValidate(){var t=$('[data-bind="questionSummaryTitle"]'),e=$('[data-bind="questionSummaryIntro"]');if(!t.text().trim()||!e.text().trim())return alert("请填写正确的问卷基本信息！"),void $("[data-publish]").toArray().some(function(t){return""===$(t).val().trim()?(t.focus(),!0):void 0});var a={title:t.text().trim(),description:e.text().trim(),questions:$(".question-preview-list >li").toArray().reduce(function(t,e){return t.push(JSON.parse(e.getAttribute("data-stringify"))),t},[])};return 0===a.questions.length?void alert("请至少添加一道题！"):a}function saveQuestionnaire(t){var e=readQuestionnaireCache();e.unshift(t),localStorage.cacheQuestion=JSON.stringify(e),window.hasSave=!0,alert("暂存成功，该问卷需要到问卷管理页面下进行相应设置！"),location.href="/questionnaire/cn/question-manage"}function readQuestionnaireCache(){try{var t=JSON.parse(localStorage.cacheQuestion)}catch(e){return[]}return[].concat(t)}$(document).on("click","label[for]",function(){var t=$(this),e=t.find("input").length?t.find("input").focus()[0]:t.focus()[0];setTimeout(function(){e.checked=!0,$(e).is('[value="link"]')&&$("[data-hide]").hide()||$("[data-hide]").show()})}),$(document).on("keyup","[data-publish]",function(){$('[data-bind="'+this.name+'"]').text(this.value)}),window.onbeforeunload=function(){return"/questionnaire/cn/create-question"===location.pathname?window.hasSave?void 0:"您创建的问卷尚未保存提交，现在离开页面将不记录任何信息，您确定要离开吗？":void 0};var questionContainer=$(".question-setting-container"),changeRelatedProperty=$(".changeRelatedProperty");$(document).on("change","[data-tmpl-id]",function(){var t=$(this),e=parseTmpl({id:this.getAttribute("data-tmpl-id"),data:{}});"3"==t.val()?$(".changeRelatedProperty").hide():$(".changeRelatedProperty").show(),$(".question-setting-container").html(e)}),$(function(){$("[data-tmpl-id]").eq(0).click()});var dataCache="";$(document).on("change",".related-or-not",function(){var t=$(this);setTimeout(function(){t[0].checked?getRelatedDataAndShowList():($('[name="relatedProperty"]').hide(),$("[data-tmpl-id]").prop("disabled",!1).filter(":checked").change())})}),$(document).on("change",'[name="relatedProperty"]',function(){var t=$(this);$("[data-tmpl-id]").prop("disabled",!0),setTimeout(function(){$('[data-tmpl-id][value="'+t[0].value+'"]').prop("disabled",!1).click()});var e="";setTimeout(function(){e=t[0].selectedOptions[0],$('[data-bind="relatedProperty"]').text(e.innerHTML);var a=dataCache.reduce(function(t,e){return e.attribute_id.toString()===t.attribute_id&&(t.item=e),t},{attribute_id:e.getAttribute("data-id")});createItem(a.item),setTimeout(function(){$("[data-create]").hide()})})});var createMap={plus:function(){createItem({},"append"),setTimeout(function(){$(".question-option-list > li").eq(-1).remove()})},minus:function(){return 2===$(".question-option-list > li").length?void alert("最少两个选项，不能再删了！"):void $(this).closest("li").remove()}};$(document).on("click","[data-create]",function(t){!$(".related-or-not")[0].checked&&createMap[this.getAttribute("data-create")].call(this,t)}),$(document).on("click",'[data-role="addNewQuestion"]',function(){setTimeout(function(){if($('[data-role="saveEditQuestion"]:visible').length)return void alert("请先将正在编辑的题目保存一下！");var t=validateAndGetQuestionData.call(this);t&&createQuestionPreviewItem(t)})}),$(document).on("click",'[data-role="remove-question"]',function(){$(this).closest("li").remove()}),$(document).on("click","[data-save-question]",function(){if(validateUrl()){var t=getQuestionnaireDataAndValidate.call(this);t&&saveQuestionnaire(t)}});
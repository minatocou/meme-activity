$(function(){var e=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles",container:"uploadFile",drop_element:"container",max_file_size:"2048mb",flash_swf_url:"loader/Moxie.swf",dragdrop:!0,chunk_size:"4mb",uptoken_func:function(e){var n,t=$(".videoForm select[name=category] option:selected").html();return $.ajax({url:"/api/qiniu/uptoken?file_name="+e.name+"&category="+t,type:"get",dataType:"json",async:!1,success:function(e){1==e.code&&(n=e.uptoken)}}),n},get_new_uptoken:!0,domain:$("#domain").val(),auto_start:!1,unique_names:!1,save_key:!1,init:{FilesAdded:function(e,n){n[0];return"请选择"==$(".videoForm select[name=category]").val()?void alert("为了方便视频在七牛云存储的管理,请先选择视频分类!"):(e.start(),void plupload.each(n,function(e){var n=new FileProgress(e);n.setStatus("等待...")}))},BeforeUpload:function(e,n){var t=new FileProgress(n),o=plupload.parseSize(this.getOption("chunk_size"));"html5"===e.runtime&&o&&t.setChunkProgess(o)},UploadProgress:function(e,n){100==n.percent?$("#uploadProgress .pro").html("视频上传成功").show().siblings().hide():($("#uploadProgress .pro").show().siblings().hide(),$("#uploadProgress .pro span").html(n.percent+"%"))},Key:function(e,o){var i=$(".videoForm select[name=category] option:selected").html(),a=o.name,r=a.substring(0,a.lastIndexOf(".")),s=a.substring(a.lastIndexOf(".")),l=r.replace(/\s/g,""),o=n(l),d=t(),u=$("#qiniuFileHeader").val()+"_"+d+"_"+i+"_"+o+s;return u},UploadComplete:function(){$("#success").show()},FileUploaded:function(e,n,t){var o=e.getOption("domain"),i=JSON.parse(t);$("#uploadProgress .waiting").html("视频等待压缩").show().siblings().hide();var a=setInterval(function(){$.ajax({url:"/api/qiniu/prefop?id="+i.persistentId,type:"get",dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,success:function(e){if(0==e.code){$("#uploadProgress .success").html("视频压缩成功").show().siblings().hide();var n,t;if(e.items.length>0)for(var i=0;i<e.items.length;i++)e.items[i].cmd.indexOf("jpg")>0?t="http://"+o+"/"+encodeURIComponent(e.items[i].key)+"?imageView2/0/w/750/h/1600":e.items[i].cmd.indexOf("mp4")>0&&(n="http://"+o+"/"+encodeURIComponent(e.items[i].key));$(".videoForm").find("input[name=video_url]").val(n),$(".videoForm").find("input[name=video_img]").val(t),$(".videoImg").attr("src",t),$(".videoForm").find("input[name=img_url]").val(t),$(".videoForm .imgBox").addClass("showImg"),$(".imgUrl").attr("src",t),clearInterval(a)}else 1==e.code?$("#uploadProgress .waiting").html("视频等待压缩").show().siblings().hide():2==e.code?$("#uploadProgress .waiting").html("视频正在压缩").show().siblings().hide():(3==e.code||4==e.code)&&($("#uploadProgress .fail").html("视频压缩失败,请重新上传").siblings().hide(),clearInterval(a))}})},2e3)},Error:function(e,n,t){alert(t)}}});e.bind("FileUploaded",function(){console.log("hello man,a file is uploaded")}),$("#container").on("dragenter",function(e){e.preventDefault(),$("#container").addClass("draging"),e.stopPropagation()}).on("drop",function(e){e.preventDefault(),$("#container").removeClass("draging"),e.stopPropagation()}).on("dragleave",function(e){e.preventDefault(),$("#container").removeClass("draging"),e.stopPropagation()}).on("dragover",function(e){e.preventDefault(),$("#container").addClass("draging"),e.stopPropagation()}),$("body").on("click","table button.btn",function(){$(this).parents("tr").next().toggle()});var n=function(e){for(var n=new RegExp("[`~!@#$^&*()=|{}':;',\\[\\].<>/?~！@#￥……&*（）&;|{}【】‘；：”“'。，、？]"),t="",o=0;o<e.length;o++)t+=e.substr(o,1).replace(n,"");return t},t=function(){var e=new Date,n=e.getFullYear(),t=e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,o=e.getDate()<10?"0"+e.getDate():e.getDate();return n+t+o}});
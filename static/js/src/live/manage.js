function showMsg(e){var n=$(".message-list-container"),o=n.children();o.length>=500&&$(o[0]).remove(),n.append(template("message-item-tmpl",e)),setTimeout(function(){n[0].scrollTop=n[0].scrollHeight})}function getUserName(e,n){e&&"number"==typeof Number(e)&&(e=e.toString().replace(/(\d{3})\d{4}(\d{4})/,"$1****$2")),e&&(n.user=n.user+"("+e+")")}$.ajaxSetup({cache:!1}),$(document).ajaxStart(function(){$(".ajax-loading-backdrop").show()}).ajaxStop(function(){$(".ajax-loading-backdrop").hide()});var appKey=$("body").data("rongyun-appkey");RongIMLib.RongIMClient.init(appKey),RongIMClient.setConnectionStatusListener({onChanged:function(e){switch(e){case RongIMLib.ConnectionStatus.CONNECTED:console.log("链接成功");break;case RongIMLib.ConnectionStatus.CONNECTING:console.log("正在链接");break;case RongIMLib.ConnectionStatus.DISCONNECTED:console.log("断开连接");break;case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:console.log("其他设备登录");break;case RongIMLib.ConnectionStatus.DOMAIN_INCORRECT:console.log("域名不正确");break;case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:console.log("网络不可用")}}});var msgMap={"MBox:TotalInoutMsg":function(e){var n={0:"加入了房间",1:"退出了房间"};e.userNames&&e.userNames.length>1||e.userIds&&e.userIds.length>1?n[e.type]="等一群蜜米们"+n[e.type]:"";var o={msg:n[e.type],user:e.name?e.name:e.userNames?e.userNames[0]:e.userIds[0]};showMsg(o)},"MBox:SyncChatRoomInfo":function(e){$.each(e,function(e,n){$('[data-bind="'+e+'"]').text(n)})}};RongIMClient.setOnReceiveMessageListener({onReceived:function(e){switch(e.messageType){case RongIMClient.MessageType.TextMessage:console.log(e,"");var n={msg:e.content.content.replace(//g,"\\表情"),user:e.content.user&&(e.content.user.name||e.content.user.id)||"游客",admin:e.content.user&&e.content.user.id&&e.content.user.id===$(".live-room-name").text().trim()+"_admin"};getUserName(e.content.extra,n),showMsg(n);break;case RongIMClient.MessageType.VoiceMessage:break;case RongIMClient.MessageType.ImageMessage:console.log(e);break;case RongIMClient.MessageType.DiscussionNotificationMessage:break;case RongIMClient.MessageType.LocationMessage:break;case RongIMClient.MessageType.RichContentMessage:console.log(e);break;case RongIMClient.MessageType.InformationNotificationMessage:break;case RongIMClient.MessageType.ContactNotificationMessage:break;case RongIMClient.MessageType.ProfileNotificationMessage:break;case RongIMClient.MessageType.CommandNotificationMessage:break;case RongIMClient.MessageType.CommandMessage:break;case RongIMClient.MessageType.UnknownMessage:"MBox:SyncChatRoomInfo"!=e.objectName&&console.log(e),msgMap[e.objectName]&&msgMap[e.objectName](e.content.message.content)}}}),$(".sendBtn").click(function(){return $(".adminInput").val().length>100?void alert("管理员发言文字长度不能超过100!"):void $(".admin-form").submit()}),$(".admin-form").submit(function(e){if(e.preventDefault(),!$(".adminInput").val().trim())return alert("请输入文本哦！"),void $(".adminInput").val("");var n=new RongIMLib.TextMessage({content:$(".adminInput").val(),user:{name:"直播管理员",id:$(".live-room-name").text().trim()+"_admin"},extra:"附加信息"}),o=RongIMLib.ConversationType.CHATROOM,a=chatRoomId;RongIMClient.getInstance().sendMessage(o,a,n,{onSuccess:function(e){console.log("Send successfully"),$(".adminInput").val("");var n={msg:e.content.content,user:e.content.user&&e.content.user.name||e.content.user.id,admin:e.content.user.id===$(".live-room-name").text().trim()+"_admin"};showMsg(n)},onError:function(e){var n="";switch(e){case RongIMLib.ErrorCode.TIMEOUT:n="超时";break;case RongIMLib.ErrorCode.UNKNOWN_ERROR:n="未知错误";break;case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:n="在黑名单中，无法向对方发送消息";break;case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:n="不在讨论组中";break;case RongIMLib.ErrorCode.NOT_IN_GROUP:n="不在群组中";break;case RongIMLib.ErrorCode.NOT_IN_CHATROOM:n="不在聊天室中";break;default:n="其他未知错误"}console.log("发送失败:"+n)}})});var liveRoomId=$(".liveCon").find("input[name='liveRoomId']").val(),chatRoomId=$(".liveCon").find("input[name='chatroomId']").val(),param={liveRoomId:chatRoomId};$.ajax({type:"get",data:param,url:"/api/internal/sas/live/getChatToken",dataType:"json"}).then(function(e){1==!e.code?alert(e.msg):RongIMClient.connect(e.data.chatToken,{onSuccess:function(e){console.log("Login successfully."+e);var n=50;console.log(RongIMClient.getInstance()),RongIMClient.getInstance().joinChatRoom(chatRoomId,n,{onSuccess:function(){console.log("加入聊天室成功")},onError:function(){console.log("加入聊天室失败")}});var o=10,a=RongIMLib.GetChatRoomType.REVERSE;RongIMClient.getInstance().getChatRoomInfo(chatRoomId,o,a,{onSuccess:function(e){console.log(JSON.stringify(e)),console.log(e.userInfos),console.log(e.userTotalNums)},onError:function(){}})},onTokenIncorrect:function(){console.log("token无效")},onError:function(e){var n="";switch(e){case RongIMLib.ErrorCode.TIMEOUT:n="超时";break;case RongIMLib.ErrorCode.UNKNOWN_ERROR:n="未知错误";break;case RongIMLib.ErrorCode.UNACCEPTABLE_PaROTOCOL_VERSION:n="不可接受的协议版本";break;case RongIMLib.ErrorCode.IDENTIFIER_REJECTED:n="appkey不正确";break;case RongIMLib.ErrorCode.SERVER_UNAVAILABLE:n="服务器不可用"}console.log(e)}})});